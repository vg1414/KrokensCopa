<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krokens Copa - Premier League</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #3b82f6 100%);
            padding: 0;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 30px;
            overflow: hidden;
            position: relative;
            text-align: center;
        }

        .banner-content {
            padding: 40px 30px;
            position: relative;
            z-index: 2;
        }

        .banner-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.15;
            background-image: 
                repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.05) 35px, rgba(255,255,255,.05) 70px);
            z-index: 1;
        }

        .banner-fish {
            position: absolute;
            font-size: 5em;
            opacity: 0.2;
            z-index: 1;
            animation: swim 4s ease-in-out infinite;
        }

        .banner-fish-left {
            left: 30px;
            top: 50%;
            transform: translateY(-50%) rotate(-20deg);
        }

        .banner-fish-right {
            right: 30px;
            top: 50%;
            transform: translateY(-50%) rotate(20deg);
            animation-delay: 2s;
        }

        @keyframes swim {
            0%, 100% { 
                transform: translateY(-50%) translateX(0) rotate(-20deg); 
            }
            50% { 
                transform: translateY(-55%) translateX(5px) rotate(-15deg); 
            }
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px;
            margin-bottom: 15px;
        }

        .fishing-hook {
            font-size: 5em;
            line-height: 1;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
            animation: swing 3s ease-in-out infinite;
        }

        @keyframes swing {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        h1 {
            color: white;
            font-size: 3.5em;
            margin: 0;
            text-shadow: 0 4px 12px rgba(0,0,0,0.4);
            font-weight: 800;
            letter-spacing: 2px;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2em;
            text-shadow: 0 2px 6px rgba(0,0,0,0.3);
            margin-top: 10px;
            font-weight: 500;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 500px;
            margin: 0 auto;
        }

        .login-title {
            font-size: 1.8em;
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .user-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab:hover {
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .content {
            display: none;
        }

        .content.active {
            display: block;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .section-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-danger {
            background: #dc3545;
        }

        .matches-list {
            display: grid;
            gap: 15px;
        }

        .match-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .match-teams {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .match-details {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .match-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .match-locked {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            color: #856404;
            font-weight: 600;
        }

        .prediction-section {
            display: grid;
            gap: 20px;
        }

        .prediction-match {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            position: relative;
            width: 100%;
            box-sizing: border-box;
        }

        .prediction-match.locked {
            background: #e9ecef;
            border: 2px solid #6c757d;
        }

        .locked-overlay {
            background: rgba(255, 243, 205, 0.95);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            color: #856404;
            margin-top: 15px;
            border: 2px solid #ffc107;
        }

        .outcome-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .outcome-btn {
            flex: 1;
            padding: 20px;
            font-size: 1.3em;
            font-weight: bold;
            border: 3px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .outcome-btn:hover:not(:disabled) {
            border-color: #667eea;
        }

        .outcome-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .outcome-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .outcome-label {
            font-size: 0.6em;
            margin-top: 5px;
        }

        .predictions-revealed {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #667eea;
        }

        .predictions-revealed h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .prediction-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .prediction-row:last-child {
            border-bottom: none;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .leaderboard-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #667eea;
        }

        .rank {
            font-size: 1.5em;
            font-weight: bold;
        }

        .rank-1 { color: #FFD700; }
        .rank-2 { color: #333; }
        .rank-3 { color: #333; }
        .rank-4 { color: #FF8C00; }
        .rank-5 { color: #DC3545; }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .modal-match-info {
            text-align: center;
            font-size: 1.1em;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .modal-outcome-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .modal-outcome-btn {
            padding: 30px 15px;
            font-size: 1.5em;
            font-weight: bold;
            border: 3px solid #e0e0e0;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-outcome-btn:hover {
            border-color: #667eea;
        }

        .modal-outcome-btn.selected {
            background: #667eea;
            color: white;
        }

        .modal-outcome-label {
            display: block;
            font-size: 0.5em;
            margin-top: 8px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-actions button {
            flex: 1;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .score-input {
            width: 38px;
            padding: 6px 2px;
            text-align: center;
            font-size: 1em;
            font-weight: bold;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            flex-shrink: 0;
            -moz-appearance: textfield;
        }

        .score-input::-webkit-outer-spin-button,
        .score-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .score-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .score-entry {
            padding: 4px 0;
        }

        .score-entry-teams {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .score-team {
            font-weight: 700;
            font-size: 0.88em;
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .score-team-home { text-align: right; }
        .score-team-away { text-align: left; }

        .score-inputs {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }

        .score-dash {
            font-weight: bold;
            font-size: 1em;
            color: #999;
        }

        .score-label {
            text-align: center;
            margin-bottom: 8px;
            min-height: 20px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            h1 {
                font-size: 1.8em;
            }

            .tabs {
                flex-direction: column;
            }

            .card {
                padding: 12px;
            }

            .prediction-match {
                padding: 12px;
            }

            .score-team {
                font-size: 0.82em;
            }

            .score-entry-teams {
                gap: 6px;
            }

            .score-inputs {
                gap: 4px;
            }

            .outcome-buttons {
                flex-direction: column;
            }

            .leaderboard-table th,
            .leaderboard-table td {
                padding: 10px 6px;
                font-size: 0.85em;
                text-align: center;
            }

            .leaderboard-table th:nth-child(2),
            .leaderboard-table td:nth-child(2) {
                text-align: left;
            }

            .rank {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="banner-bg"></div>
            <div class="banner-fish banner-fish-left">üé£</div>
            <div class="banner-fish banner-fish-right">üé£</div>
            <div class="banner-content">
                <div class="logo-container">
                    <span class="fishing-hook">üé£</span>
                    <h1>Krokens Copa</h1>
                </div>
                <p class="subtitle">Premier League Tippning ‚öΩ</p>
            </div>
        </header>

        <div id="loginScreen">
            <div class="login-container">
                <h2 class="login-title">V√§lkommen! üé£</h2>
                <div id="statusContainer"></div>
                <div class="form-group">
                    <label for="playerSelect">V√§lj spelare:</label>
                    <select id="playerSelect">
                        <option value="">V√§lj spelare...</option>
                        <option value="Hefner">Hefner</option>
                        <option value="Majscht">Majscht</option>
                        <option value="Olle">Olle</option>
                        <option value="Dawod">Dawod</option>
                        <option value="Ante">Ante</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="passwordInput">L√∂senord:</label>
                    <input type="password" id="passwordInput" placeholder="Skriv ditt l√∂senord">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        F√∂rsta g√•ngen? V√§lj ett l√∂senord som du kommer ih√•g!
                    </small>
                </div>
                <button class="btn" id="loginButton" style="width: 100%;">Logga in</button>
            </div>
        </div>

        <div id="mainApp" style="display: none;">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div class="user-badge">
                        <span>üë§ Inloggad som:</span>
                        <strong id="currentUserName"></strong>
                    </div>
                    <button class="btn btn-secondary" id="logoutButton">Logga ut</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="setup">üìÖ Matcher</button>
                <button class="tab" data-tab="predict">üéØ Tippa</button>
                <button class="tab" data-tab="leaderboard">üèÜ Topplista</button>
                <button class="tab" id="adminTab" data-tab="admin" style="display: none;">‚öôÔ∏è Admin</button>
            </div>

            <div id="setup" class="content active">
                <div class="card">
                    <h2 class="section-title">‚öΩ Premier League Matcher</h2>
                    <div id="lastFetchStatus" style="font-size: 0.85em; color: #888; margin-bottom: 15px;"></div>
                    <div class="matches-list" id="matchesList">
                        <div class="empty-state">V√§ntar p√• att matcher laddas in...</div>
                    </div>
                </div>
            </div>

            <div id="predict" class="content">
                <div class="card">
                    <h2 class="section-title">üéØ Tippa matcher</h2>
                    <div class="prediction-section" id="predictionsList"></div>
                </div>
            </div>

            <div id="leaderboard" class="content">
                <div class="card">
                    <h2 class="section-title">üèÜ Topplista</h2>
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Spelare</th>
                                <th>Po√§ng</th>
                                <th>R√§tt</th>
                                <th>‚≠ê</th>
                                <th>Snitt</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody"></tbody>
                    </table>
                    
                    <!-- Sniper title -->
                    <div id="sniperSection" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; display: none;">
                        <div style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #8B5CF6;">
                            <div style="font-size: 1.1em; font-weight: 600; color: #8B5CF6; margin-bottom: 5px;">
                                üéØ Ligans Sniper
                            </div>
                            <div id="sniperName" style="font-size: 1.3em; font-weight: bold; color: #333;"></div>
                            <div id="sniperDetails" style="font-size: 0.9em; color: #666; margin-top: 4px;"></div>
                        </div>
                    </div>
                    
                    <!-- Special titles for bottom positions -->
                    <div id="specialTitles" style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; display: none;">
                        <div style="display: grid; gap: 15px;">
                            <div id="masterSection" style="display: none; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #FFD700;">
                                <div style="font-size: 1.1em; font-weight: 600; color: #FFD700; margin-bottom: 5px;">
                                    üëë M√§stare
                                </div>
                                <div id="masterName" style="font-size: 1.3em; font-weight: bold; color: #333;"></div>
                            </div>
                            
                            <div id="sousChefSection" style="display: none; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #FF8C00;">
                                <div style="font-size: 1.1em; font-weight: 600; color: #FF8C00; margin-bottom: 5px;">
                                    üç≥ Sous-chef
                                </div>
                                <div id="sousChefName" style="font-size: 1.3em; font-weight: bold; color: #333;"></div>
                            </div>
                            
                            <div id="chefSection" style="display: none; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #DC3545;">
                                <div style="font-size: 1.1em; font-weight: 600; color: #DC3545; margin-bottom: 5px;">
                                    üë®‚Äçüç≥ Chef
                                </div>
                                <div id="chefName" style="font-size: 1.3em; font-weight: bold; color: #333;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Modal (only for Hefner) -->
        <div id="resultModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">S√§tt resultat</div>
                <div class="modal-match-info" id="modalMatchInfo"></div>
                <div class="modal-outcome-buttons" id="modalOutcomeButtons" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr;">
                    <button class="modal-outcome-btn" data-outcome="1">
                        1
                        <span class="modal-outcome-label" id="modalHome">Hemma</span>
                    </button>
                    <button class="modal-outcome-btn" data-outcome="X">
                        X
                        <span class="modal-outcome-label">Oavgjort</span>
                    </button>
                    <button class="modal-outcome-btn" data-outcome="2">
                        2
                        <span class="modal-outcome-label" id="modalAway">Borta</span>
                    </button>
                    <button class="modal-outcome-btn" data-outcome="POSTPONED" style="background: #fef3c7; border-color: #f59e0b;">
                        ‚ö†Ô∏è
                        <span class="modal-outcome-label">Inst√§lld</span>
                    </button>
                    <button class="modal-outcome-btn" data-outcome="null" style="background: #f8f9fa;">
                        üóëÔ∏è
                        <span class="modal-outcome-label">Rensa</span>
                    </button>
                </div>
                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                    <div style="font-size: 0.9em; font-weight: 600; color: #667eea; margin-bottom: 10px; text-align: center;">‚≠ê Exakt resultat (f√∂r resultatbonus)</div>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span id="modalScoreHome" style="font-weight: 600;">Hemma</span>
                        <input type="number" min="0" max="99" id="modalHomeScore" style="width: 55px; padding: 10px; text-align: center; font-size: 1.3em; font-weight: bold; border: 2px solid #e0e0e0; border-radius: 8px;" placeholder="-">
                        <span style="font-weight: bold; font-size: 1.3em;">-</span>
                        <input type="number" min="0" max="99" id="modalAwayScore" style="width: 55px; padding: 10px; text-align: center; font-size: 1.3em; font-weight: bold; border: 2px solid #e0e0e0; border-radius: 8px;" placeholder="-">
                        <span id="modalScoreAway" style="font-weight: 600;">Borta</span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" id="modalCancelBtn">Avbryt</button>
                    <button class="btn" id="modalSaveBtn">Spara</button>
                </div>
            </div>
        </div>

        <!-- Admin Panel (Hefner only) -->
        <div id="admin" class="content">
            <div class="card">
                <h2 class="section-title">‚öôÔ∏è Admin-panel (Hefner)</h2>
                
                <!-- Activity Log -->
                <div style="margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #1e40af;">üìä Aktivitetslogg</h3>
                        <button class="btn btn-secondary" onclick="refreshActivityLog()" style="padding: 8px 16px;">üîÑ Uppdatera</button>
                    </div>
                    <div id="activityLog" style="background: #0a0a0a; color: #10b981; padding: 20px; border-radius: 10px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; border: 1px solid #333;">
                        Laddar aktivitetslogg...
                    </div>
                </div>
                
                <!-- API Configuration -->
                <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                    <h3 style="color: #15803d; margin-bottom: 10px;">‚öΩ Auto-r√§ttning</h3>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                        H√§mtar automatiskt PL-resultat fr√•n football-data.org API. Aktivera f√∂r att slippa s√§tta resultat manuellt.
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <button class="btn" style="background: #15803d;" onclick="toggleAutoFetch()">
                            <span id="autoFetchBtnText">‚öΩ Aktivera auto-h√§mtning</span>
                        </button>
                        <button class="btn btn-secondary" onclick="manualFetchResults()">üîÑ H√§mta resultat nu</button>
                        <span id="autoFetchStatus" style="font-size: 0.85em; color: #666;"></span>
                    </div>
                    <div id="fetchLog" style="background: #0a0a0a; color: #10b981; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.85em; white-space: pre-wrap; max-height: 200px; overflow-y: auto; margin-top: 15px; display: none;"></div>
                </div>

                <div style="background: rgba(239, 68, 68, 0.1); border: 2px solid #ef4444; border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                    <h3 style="color: #ef4444; margin-bottom: 10px;">‚ö†Ô∏è Farliga √•tg√§rder</h3>
                    <p style="color: #666; margin-bottom: 15px;">Dessa knappar p√•verkar ALLA spelare. Var f√∂rsiktig!</p>
                </div>

                <div style="display: grid; gap: 20px;">
                    <!-- Load Matches -->
                    <div style="background: #f0f9ff; border-radius: 10px; padding: 20px;">
                        <h3 style="color: #1e40af; margin-bottom: 10px;">üîÑ Ladda in matcher</h3>
                        <p style="color: #666; margin-bottom: 10px; font-size: 0.9em;">
                            H√§mtar kommande omg√•ngar fr√•n Premier League via API. V√§lj hur m√•nga omg√•ngar som ska tippas samtidigt.
                        </p>
                        <p style="color: #f59e0b; margin-bottom: 15px; font-size: 0.85em; background: #fef3c7; padding: 8px; border-radius: 5px;">
                            ‚ÑπÔ∏è Anv√§nder CORS proxy (corsproxy.io) f√∂r att n√• API:et. Om det inte fungerar, prova igen om n√•gra minuter.
                        </p>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                            <label for="roundsToLoad" style="font-weight: 600; color: #1e40af;">Antal omg√•ngar att ladda:</label>
                            <select id="roundsToLoad" style="padding: 10px; border: 2px solid #3b82f6; border-radius: 8px; font-size: 1em; font-weight: 600; color: #1e40af; background: white; cursor: pointer;">
                                <option value="1">1 omg√•ng</option>
                                <option value="2" selected>2 omg√•ngar</option>
                                <option value="3">3 omg√•ngar</option>
                                <option value="4">4 omg√•ngar</option>
                                <option value="5">5 omg√•ngar</option>
                                <option value="6">6 omg√•ngar</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="adminLoadMatches()">
                            ‚öΩ H√§mta valda PL-omg√•ngar
                        </button>
                    </div>

                    <!-- Reset Predictions -->
                    <div style="background: #fef2f2; border-radius: 10px; padding: 20px;">
                        <h3 style="color: #dc2626; margin-bottom: 10px;">üóëÔ∏è Nollst√§ll tippningar</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                            Raderar ALLA spelares tippningar. Matcher och resultat beh√•lls. Alla kan b√∂rja tippa fr√•n b√∂rjan.
                        </p>
                        <button class="btn" style="background: #ef4444;" onclick="adminResetPredictions()">
                            üóëÔ∏è Nollst√§ll ALLA tippningar
                        </button>
                    </div>

                    <!-- Reset Results -->
                    <div style="background: #fef2f2; border-radius: 10px; padding: 20px;">
                        <h3 style="color: #dc2626; margin-bottom: 10px;">üîÑ Nollst√§ll resultat</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 0.9em;">
                            Raderar alla matchresultat. Tippningar beh√•lls. Bra om fel resultat satts.
                        </p>
                        <button class="btn" style="background: #ef4444;" onclick="adminResetResults()">
                            üîÑ Nollst√§ll alla resultat
                        </button>
                    </div>

                    <!-- Full Reset -->
                    <div style="background: #450a0a; border-radius: 10px; padding: 20px; border: 3px solid #dc2626;">
                        <h3 style="color: #fca5a5; margin-bottom: 10px;">üí£ TOTAL RESET</h3>
                        <p style="color: #fca5a5; margin-bottom: 15px; font-size: 0.9em;">
                            Raderar ALLT: matcher, tippningar, resultat. B√∂rja om fr√•n scratch. (L√∂senord beh√•lls)
                        </p>
                        <button class="btn" style="background: #7f1d1d; color: white;" onclick="adminFullReset()">
                            üí£ TOTAL RESET - Radera allt
                        </button>
                    </div>
                </div>

                <div id="adminOutput" style="background: #000; color: #10b981; padding: 20px; border-radius: 10px; margin-top: 30px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; display: none;"></div>
            </div>
        </div>
    </div>

    <div style="text-align: center; padding: 20px; opacity: 0.5; font-size: 0.75em; color: #94a3b8;">
        Made by David Hefner
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyB2E_bnuPxJW9AtuxnA1LyewTVuA-LpOwk",
            authDomain: "krokens-copa.firebaseapp.com",
            databaseURL: "https://krokens-copa-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "krokens-copa",
            storageBucket: "krokens-copa.firebasestorage.app",
            messagingSenderId: "845438921539",
            appId: "1:845438921539:web:c7ab471f954a81d9469df6"
        };

        // Global state
        let app, database;
        let matches = [];
        let predictions = {};
        let exactPredictions = {};
        let passwords = {};
        let activityLog = [];
        let activityLogLoaded = false; // Track if we've loaded from Firebase
        let currentUser = null;
        let currentModalMatchId = null;
        let currentModalOutcome = null;
        let plApiKey = '406217531e18462e97f40aea2c744b8e'; // football-data.org API key (h√•rdkodad)
        let autoFetchInterval = null; // Auto-fetch timer
        let autoFetchActive = false;

        const PLAYERS = ['Hefner', 'Majscht', 'Olle', 'Dawod', 'Ante'];
        
        // Session management (10 minute auto-login)
        const SESSION_DURATION = 10 * 60 * 1000; // 10 minutes
        
        function saveSession(player) {
            const session = {
                player: player,
                timestamp: Date.now()
            };
            localStorage.setItem('krokens_session', JSON.stringify(session));
        }
        
        function loadSession() {
            const sessionData = localStorage.getItem('krokens_session');
            if (!sessionData) return null;
            
            const session = JSON.parse(sessionData);
            const age = Date.now() - session.timestamp;
            
            if (age > SESSION_DURATION) {
                localStorage.removeItem('krokens_session');
                return null;
            }
            
            return session.player;
        }
        
        function clearSession() {
            localStorage.removeItem('krokens_session');
        }
        
        // Activity logging
        async function logActivity(action, details = '') {
            // Don't log if we haven't loaded the activity log yet
            if (!activityLogLoaded) {
                console.warn('Activity log not loaded yet, skipping log entry');
                return;
            }
            
            const entry = {
                timestamp: new Date().toISOString(),
                user: currentUser,
                action: action,
                details: details
            };
            
            activityLog.unshift(entry); // Add to beginning
            
            // Keep only last 100 entries
            if (activityLog.length > 100) {
                activityLog = activityLog.slice(0, 100);
            }
            
            try {
                await set(ref(database, 'activityLog'), activityLog);
            } catch (error) {
                console.error('Failed to log activity:', error);
            }
        }

        // Premier League configuration
        const PL_LEAGUE_ID = 39; // Premier League ID in API-Football
        const CURRENT_SEASON = 2024; // 2024-2025 season
        let currentRound = null; // Will be fetched from API

        // Simple hash function
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function showStatus(message, type = 'info') {
            const container = document.getElementById('statusContainer');
            if (container) {
                container.innerHTML = `<div class="status status-${type}">${message}</div>`;
                setTimeout(() => { container.innerHTML = ''; }, 4000);
            }
        }

        function isMatchStarted(matchDate) {
            const now = new Date();
            const matchTime = new Date(matchDate);
            return now >= matchTime;
        }

        function getFirstMatch() {
            if (!matches || matches.length === 0) return null;
            return matches.reduce((earliest, m) =>
                new Date(m.date) < new Date(earliest.date) ? m : earliest
            );
        }

        function isFirstMatchStarted() {
            const first = getFirstMatch();
            if (!first) return false;
            return isMatchStarted(first.date);
        }

        // Initialize Firebase
        console.log('Initializing Firebase...');
        try {
            app = initializeApp(firebaseConfig);
            database = getDatabase(app);
            console.log('Firebase initialized successfully');
            
            // Start listeners
            const matchesRef = ref(database, 'matches');
            onValue(matchesRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    matches = Array.isArray(data) ? data : Object.values(data);
                    console.log('Matches loaded:', matches.length);
                    renderMatches();
                    renderPredictions();
                    renderLeaderboard();
                }
            });

            const predictionsRef = ref(database, 'predictions');
            onValue(predictionsRef, (snapshot) => {
                predictions = snapshot.val() || {};
                console.log('Predictions loaded');
                renderPredictions();
                renderLeaderboard();
                renderMatches();
            });

            const exactPredictionsRef = ref(database, 'exactPredictions');
            onValue(exactPredictionsRef, (snapshot) => {
                exactPredictions = snapshot.val() || {};
                console.log('Exact predictions loaded');
                renderPredictions();
                renderLeaderboard();
                renderMatches();
            });

            const passwordsRef = ref(database, 'passwords');
            onValue(passwordsRef, (snapshot) => {
                passwords = snapshot.val() || {};
                console.log('Passwords loaded');
                
                // Check for existing session on first load
                if (!currentUser) {
                    const sessionPlayer = loadSession();
                    if (sessionPlayer && passwords[sessionPlayer]) {
                        console.log('Auto-login from session:', sessionPlayer);
                        currentUser = sessionPlayer;
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        document.getElementById('currentUserName').textContent = sessionPlayer;
                        
                        // Show admin tab for Hefner
                        const adminTab = document.getElementById('adminTab');
                        if (adminTab) {
                            adminTab.style.display = sessionPlayer === 'Hefner' ? 'inline-block' : 'none';
                        }
                        
                        renderPredictions();
                        logActivity('AUTO_LOGIN', 'Automatisk inloggning fr√•n session');

                        // Restore auto-fetch if Hefner had it active
                        if (sessionPlayer === 'Hefner' && localStorage.getItem('krokens_autofetch') === 'true' && !autoFetchActive) {
                            autoFetchActive = true;
                            autoFetchInterval = setInterval(fetchPLResults, 15 * 60 * 1000);
                            updateAutoFetchUI();
                        }
                    }
                }
            });

            const lastFetchRef = ref(database, 'lastAutoFetch');
            onValue(lastFetchRef, (snapshot) => {
                const ts = snapshot.val();
                const el = document.getElementById('lastFetchStatus');
                if (el && ts) {
                    const time = new Date(ts).toLocaleString('sv-SE', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    el.textContent = `üîÑ Resultat senast h√§mtade: ${time}`;
                }
            });

            const activityLogRef = ref(database, 'activityLog');
            onValue(activityLogRef, (snapshot) => {
                const data = snapshot.val();
                // Only update if we got actual data, or if this is the first load
                if (data && Array.isArray(data)) {
                    activityLog = data;
                } else if (!activityLogLoaded) {
                    // First load and no data exists - start with empty array
                    activityLog = [];
                }
                activityLogLoaded = true;
                console.log('Activity log loaded:', activityLog.length, 'entries');
                if (currentUser === 'Hefner') {
                    renderActivityLog();
                }
            });

        } catch (error) {
            console.error('Firebase init error:', error);
            alert('Firebase-fel: ' + error.message);
        }

        // LOGIN FUNCTION
        async function handleLogin() {
            console.log('Login button clicked');
            const player = document.getElementById('playerSelect').value;
            const password = document.getElementById('passwordInput').value;

            console.log('Player:', player, 'Password length:', password.length);

            if (!player) {
                showStatus('‚ùå V√§lj en spelare!', 'error');
                return;
            }

            if (!password) {
                showStatus('‚ùå Skriv ett l√∂senord!', 'error');
                return;
            }

            try {
                const hashedPassword = await hashPassword(password);
                console.log('Password hashed');

                if (passwords[player]) {
                    // Verify password
                    if (passwords[player] === hashedPassword) {
                        console.log('Password correct, logging in...');
                        currentUser = player;
                        saveSession(player); // Save session for auto-login
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('mainApp').style.display = 'block';
                        document.getElementById('currentUserName').textContent = player;
                        
                        // Show admin tab for Hefner
                        const adminTab = document.getElementById('adminTab');
                        if (adminTab) {
                            adminTab.style.display = player === 'Hefner' ? 'inline-block' : 'none';
                        }
                        
                        // Log activity
                        await logActivity('LOGIN', 'Loggade in');

                        renderPredictions();

                        // Restore auto-fetch if Hefner had it active
                        if (player === 'Hefner' && localStorage.getItem('krokens_autofetch') === 'true' && !autoFetchActive) {
                            autoFetchActive = true;
                            autoFetchInterval = setInterval(fetchPLResults, 15 * 60 * 1000);
                            updateAutoFetchUI();
                        }
                    } else {
                        console.log('Wrong password');
                        showStatus('‚ùå Fel l√∂senord!', 'error');
                    }
                } else {
                    // First time - set password
                    console.log('First time login, saving password...');
                    passwords[player] = hashedPassword;
                    await set(ref(database, 'passwords'), passwords);
                    currentUser = player;
                    saveSession(player); // Save session for auto-login
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    document.getElementById('currentUserName').textContent = player;
                    
                    // Show admin tab for Hefner
                    const adminTab = document.getElementById('adminTab');
                    if (adminTab) {
                        adminTab.style.display = player === 'Hefner' ? 'inline-block' : 'none';
                    }
                    
                    // Log activity
                    await logActivity('FIRST_LOGIN', 'Skapade konto och loggade in');
                    
                    alert('‚úÖ L√∂senord sparat! V√§lkommen!');
                    renderPredictions();
                }
            } catch (error) {
                console.error('Login error:', error);
                showStatus('‚ùå Fel vid inloggning: ' + error.message, 'error');
            }
        }

        // LOGOUT FUNCTION
        async function handleLogout() {
            console.log('Logging out...');
            
            // Log activity before clearing session
            if (currentUser) {
                await logActivity('LOGOUT', 'Loggade ut');
            }
            
            currentUser = null;
            clearSession(); // Clear auto-login session
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('passwordInput').value = '';
            document.getElementById('playerSelect').value = '';
            
            // Hide admin tab
            const adminTab = document.getElementById('adminTab');
            if (adminTab) {
                adminTab.style.display = 'none';
            }
        }

        // ADMIN FUNCTIONS (Hefner only)
        function adminLog(msg, type = 'info') {
            const output = document.getElementById('adminOutput');
            if (!output) return;
            
            output.style.display = 'block';
            const colors = { success: '#10b981', error: '#ef4444', warning: '#f59e0b', info: '#60a5fa' };
            const color = colors[type] || '#10b981';
            const time = new Date().toLocaleTimeString();
            output.innerHTML += `<span style="color: ${color}">[${time}] ${msg}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        window.adminLoadMatches = async function() {
            if (currentUser !== 'Hefner') {
                alert('‚õî Endast Hefner kan anv√§nda admin-funktioner!');
                return;
            }
            
            // Get number of rounds from dropdown
            const roundsSelect = document.getElementById('roundsToLoad');
            const roundsToLoad = parseInt(roundsSelect?.value || 2);
            
            if (!confirm(`H√§mta kommande ${roundsToLoad} omg√•ng${roundsToLoad > 1 ? 'ar' : ''} fr√•n Premier League?\n\nDetta kommer ladda in matcherna fr√•n football-data.org API.`)) return;
            
            adminLog(`‚öΩ H√§mtar ${roundsToLoad} PL-omg√•ngar fr√•n API...`, 'info');
            
            try {
                // Use CORS proxy to avoid CORS issues
                // Note: For production, you should use your own backend server
                const apiUrl = 'https://api.football-data.org/v4/competitions/PL/matches?status=SCHEDULED,TIMED';
                const corsProxy = 'https://corsproxy.io/?';
                const url = corsProxy + encodeURIComponent(apiUrl);
                
                adminLog(`üîó Anropar API via CORS proxy...`, 'info');
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 
                        'X-Auth-Token': plApiKey
                    }
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    adminLog(`‚ùå API error: ${response.status} - ${errorText}`, 'error');
                    throw new Error(`API svarade med status ${response.status}`);
                }
                
                const data = await response.json();
                const allMatches = data.matches || [];
                
                adminLog(`üìä Hittade ${allMatches.length} kommande matcher totalt`, 'info');
                
                if (allMatches.length === 0) {
                    adminLog('‚ö†Ô∏è Inga kommande matcher i API:et. Kanske √§r s√§songen slut?', 'warning');
                    alert('Inga kommande matcher hittades. Kontrollera att Premier League-s√§songen p√•g√•r.');
                    return;
                }
                
                // Group matches by matchday
                const matchesByRound = {};
                allMatches.forEach(m => {
                    const round = m.matchday;
                    if (!matchesByRound[round]) matchesByRound[round] = [];
                    matchesByRound[round].push(m);
                });
                
                // Find the next X rounds that have matches (based on dropdown selection)
                const rounds = Object.keys(matchesByRound).map(Number).sort((a, b) => a - b);
                const nextRounds = rounds.slice(0, roundsToLoad);
                
                if (nextRounds.length === 0) {
                    adminLog('‚ùå Inga kommande matcher hittades!', 'error');
                    alert('Inga kommande matcher kunde hittas i API:et.');
                    return;
                }
                
                if (nextRounds.length < roundsToLoad) {
                    adminLog(`‚ö†Ô∏è Kunde bara hitta ${nextRounds.length} omg√•ngar (du valde ${roundsToLoad})`, 'warning');
                }
                
                adminLog(`üéØ Laddar omg√•ng ${nextRounds.join(', ')}`, 'info');
                
                // Convert API matches to our format
                const matchesToLoad = [];
                nextRounds.forEach(roundNum => {
                    const roundMatches = matchesByRound[roundNum];
                    roundMatches.forEach((m, idx) => {
                        // Convert UTC to CET/CEST properly using Intl
                        const utcDate = new Date(m.utcDate);
                        
                        // Get date string in CET timezone (Europe/Stockholm = CET/CEST)
                        const options = {
                            timeZone: 'Europe/Stockholm',
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        };
                        
                        const parts = new Intl.DateTimeFormat('sv-SE', options).formatToParts(utcDate);
                        const dateParts = {};
                        parts.forEach(part => {
                            dateParts[part.type] = part.value;
                        });
                        
                        // Format as ISO string for our system
                        const isoString = `${dateParts.year}-${dateParts.month}-${dateParts.day}T${dateParts.hour}:${dateParts.minute}`;
                        
                        matchesToLoad.push({
                            id: `pl_r${roundNum}_${idx}`,
                            homeTeam: m.homeTeam.shortName || m.homeTeam.name,
                            awayTeam: m.awayTeam.shortName || m.awayTeam.name,
                            league: `Premier League - Omg√•ng ${roundNum}`,
                            date: isoString,
                            actualOutcome: null,
                            actualScore: null,
                            apiMatchId: m.id
                        });
                    });
                });
                
                adminLog(`‚úÖ Konverterade ${matchesToLoad.length} matcher`, 'success');
                
                // Save to Firebase
                await set(ref(database, 'matches'), matchesToLoad);
                await logActivity('ADMIN_LOAD_MATCHES', `Laddade ${matchesToLoad.length} PL-matcher (omg√•ng ${nextRounds.join(', ')})`);
                
                adminLog(`‚úÖ KLART! ${matchesToLoad.length} matcher sparade i Firebase`, 'success');
                alert(`‚úÖ ${matchesToLoad.length} PL-matcher fr√•n omg√•ng ${nextRounds.join(' och ')} √§r nu laddade!`);
                
            } catch (error) {
                adminLog('‚ùå FEL: ' + error.message, 'error');
                console.error('Fetch error details:', error);
                
                // Provide helpful error message
                let errorMsg = '‚ùå Kunde inte h√§mta matcher fr√•n API.\n\n';
                
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    errorMsg += 'CORS-problem detekterat. M√∂jliga l√∂sningar:\n\n';
                    errorMsg += '1. Kontrollera att API-nyckeln √§r korrekt\n';
                    errorMsg += '2. CORS proxy kan vara nere - prova igen om n√•gra minuter\n';
                    errorMsg += '3. Anv√§nd en modern webbl√§sare (Chrome, Firefox, Edge)\n\n';
                    errorMsg += 'Teknisk info: ' + error.message;
                } else if (error.message.includes('401') || error.message.includes('403')) {
                    errorMsg += 'API-nyckel problem:\n';
                    errorMsg += '- Kontrollera att din API-nyckel √§r korrekt\n';
                    errorMsg += '- Verifiera p√• football-data.org att nyckeln √§r aktiv\n';
                } else {
                    errorMsg += 'Tekniskt fel: ' + error.message;
                }
                
                alert(errorMsg);
            }
        };

        window.adminResetPredictions = async function() {
            if (currentUser !== 'Hefner') {
                alert('‚õî Endast Hefner kan anv√§nda admin-funktioner!');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è NOLLST√ÑLL ALLA TIPPNINGAR?\n\nDetta raderar alla spelares tippningar!\nMatcher och resultat beh√•lls.\n\nForts√§tta?')) return;
            if (!confirm('‚ö†Ô∏è SISTA VARNINGEN!\n\nAlla tippningar raderas permanent!\n\n√Ñr du HELT s√§ker?')) return;
            
            adminLog('üóëÔ∏è Nollst√§ller tippningar...', 'warning');
            try {
                await set(ref(database, 'predictions'), {});
                await set(ref(database, 'exactPredictions'), {});
                await logActivity('ADMIN_RESET_PREDICTIONS', 'Nollst√§llde alla tippningar');
                adminLog('‚úÖ KLART! Alla tippningar raderade!', 'success');
                adminLog('üìä Tippningar: 0 kvar', 'info');
                adminLog('üìä Matcher: Beh√•llna', 'success');
                adminLog('üìä Resultat: Beh√•llna', 'success');
                alert('‚úÖ Alla tippningar raderade!');
            } catch (error) {
                adminLog('‚ùå FEL: ' + error.message, 'error');
                alert('‚ùå Fel: ' + error.message);
            }
        };

        window.adminResetResults = async function() {
            if (currentUser !== 'Hefner') {
                alert('‚õî Endast Hefner kan anv√§nda admin-funktioner!');
                return;
            }
            
            if (!confirm('‚ö†Ô∏è NOLLST√ÑLL ALLA RESULTAT?\n\nDetta raderar alla matchresultat!\nTippningar beh√•lls.\n\nForts√§tta?')) return;
            
            adminLog('üîÑ Nollst√§ller resultat...', 'warning');
            try {
                const cleanMatches = matches.map(m => ({
                    ...m,
                    actualOutcome: null,
                    setBy: null,
                    setAt: null
                }));
                await set(ref(database, 'matches'), cleanMatches);
                await logActivity('ADMIN_RESET_RESULTS', 'Nollst√§llde alla matchresultat');
                adminLog('‚úÖ KLART! Alla resultat raderade!', 'success');
                adminLog('üìä Resultat: 0 kvar', 'info');
                adminLog('üìä Tippningar: Beh√•llna', 'success');
                alert('‚úÖ Alla resultat raderade!');
            } catch (error) {
                adminLog('‚ùå FEL: ' + error.message, 'error');
                alert('‚ùå Fel: ' + error.message);
            }
        };

        window.adminFullReset = async function() {
            if (currentUser !== 'Hefner') {
                alert('‚õî Endast Hefner kan anv√§nda admin-funktioner!');
                return;
            }
            
            if (!confirm('üí£ TOTAL RESET?\n\nDetta raderar:\n- Alla matcher\n- Alla tippningar\n- Alla resultat\n\nL√∂senord beh√•lls.\n\nForts√§tta?')) return;
            if (!confirm('üí£üí£üí£ SISTA VARNINGEN! üí£üí£üí£\n\nALLT kommer raderas!\n\n√Ñr du 100% s√§ker?')) return;
            if (!confirm('Skriv OK f√∂r att bekr√§fta total reset (detta kan inte √•ngras!)') !== null) return;
            
            adminLog('üí£ TOTAL RESET p√•b√∂rjad...', 'error');
            try {
                await logActivity('ADMIN_FULL_RESET', 'Genomf√∂rde total reset (matcher + tippningar + resultat)');
                await set(ref(database, 'matches'), []);
                adminLog('‚úÖ Matcher raderade', 'success');
                await set(ref(database, 'predictions'), {});
                await set(ref(database, 'exactPredictions'), {});
                adminLog('‚úÖ Tippningar raderade', 'success');
                adminLog('üí£ TOTAL RESET KLAR!', 'warning');
                adminLog('üìä Allt borta. B√∂rja om fr√•n scratch.', 'info');
                alert('üí£ Total reset klar! Ladda nu in matcher igen fr√•n Admin-panelen.');
            } catch (error) {
                adminLog('‚ùå FEL: ' + error.message, 'error');
                alert('‚ùå Fel: ' + error.message);
            }
        };

        // ACTIVITY LOG DISPLAY
        function renderActivityLog() {
            const logDiv = document.getElementById('activityLog');
            if (!logDiv) return;
            
            if (!activityLog || activityLog.length === 0) {
                logDiv.innerHTML = '<span style="color: #6b7280;">Ingen aktivitet √§nnu...</span>';
                return;
            }
            
            const actionIcons = {
                'LOGIN': 'üîì',
                'LOGOUT': 'üîí',
                'AUTO_LOGIN': '‚ö°',
                'FIRST_LOGIN': '‚ú®',
                'PREDICT': 'üéØ',
                'PREDICT_EXACT': '‚≠ê',
                'SET_RESULT': 'üìù',
                'CLEAR_RESULT': 'üóëÔ∏è',
                'AUTO_RESULT': '‚öΩ',
                'ADMIN_LOAD_MATCHES': 'üîÑ',
                'ADMIN_RESET_PREDICTIONS': 'üí£',
                'ADMIN_RESET_RESULTS': 'üîÑ',
                'ADMIN_FULL_RESET': 'üí•',
                'ADMIN_API_KEY': 'üîë'
            };
            
            const actionColors = {
                'LOGIN': '#10b981',
                'LOGOUT': '#6b7280',
                'AUTO_LOGIN': '#3b82f6',
                'FIRST_LOGIN': '#f59e0b',
                'PREDICT': '#8b5cf6',
                'PREDICT_EXACT': '#a855f7',
                'SET_RESULT': '#06b6d4',
                'CLEAR_RESULT': '#ef4444',
                'AUTO_RESULT': '#22c55e',
                'ADMIN_LOAD_MATCHES': '#10b981',
                'ADMIN_RESET_PREDICTIONS': '#dc2626',
                'ADMIN_RESET_RESULTS': '#f59e0b',
                'ADMIN_FULL_RESET': '#7f1d1d',
                'ADMIN_API_KEY': '#15803d'
            };
            
            let html = '';
            // Reverse so oldest is first, newest is last (bottom)
            const reversedLog = [...activityLog].reverse();
            reversedLog.forEach((entry, index) => {
                const date = new Date(entry.timestamp);
                const timeStr = date.toLocaleString('sv-SE', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const icon = actionIcons[entry.action] || 'üìå';
                const color = actionColors[entry.action] || '#10b981';
                const user = entry.user || 'System';
                
                html += `<div style="color: ${color}; margin-bottom: 4px;">`;
                html += `[${timeStr}] ${icon} ${user}: ${entry.details}`;
                html += `</div>`;
            });
            
            logDiv.innerHTML = html;
            logDiv.scrollTop = logDiv.scrollHeight; // Scroll to bottom (newest entries)
        }
        
        window.refreshActivityLog = function() {
            if (currentUser !== 'Hefner') {
                alert('‚õî Endast Hefner kan se aktivitetsloggen!');
                return;
            }
            renderActivityLog();
        };

        // FOOTBALL-DATA.ORG API INTEGRATION (Premier League auto-results)
        // Free tier: 10 requests/minute, PL included forever
        
        function fetchLog(msg, type = 'info') {
            const log = document.getElementById('fetchLog');
            if (!log) return;
            log.style.display = 'block';
            const colors = { success: '#10b981', error: '#ef4444', warning: '#f59e0b', info: '#60a5fa' };
            const time = new Date().toLocaleTimeString('sv-SE');
            log.innerHTML += `<span style="color: ${colors[type] || '#10b981'}">[${time}] ${msg}</span>\n`;
            log.scrollTop = log.scrollHeight;
        }
        
        function updateAutoFetchUI() {
            const btn = document.getElementById('autoFetchBtnText');
            const status = document.getElementById('autoFetchStatus');
            if (btn) btn.textContent = autoFetchActive ? '‚èπÔ∏è Stoppa auto-h√§mtning' : '‚öΩ Aktivera auto-h√§mtning';
            if (status) status.textContent = autoFetchActive ? 'üü¢ Aktiv ‚Äì kollar var 15:e minut' : '‚ö™ Inaktiv';
        }
        
        window.toggleAutoFetch = function() {
            if (autoFetchActive) {
                // Stop
                clearInterval(autoFetchInterval);
                autoFetchInterval = null;
                autoFetchActive = false;
                localStorage.setItem('krokens_autofetch', 'false');
                fetchLog('‚èπÔ∏è Auto-h√§mtning stoppad', 'warning');
            } else {
                // Start
                autoFetchActive = true;
                localStorage.setItem('krokens_autofetch', 'true');
                fetchPLResults(); // Immediate first check
                autoFetchInterval = setInterval(fetchPLResults, 15 * 60 * 1000); // Every 15 min
                fetchLog('‚öΩ Auto-h√§mtning aktiverad (var 15:e minut)', 'success');
            }
            updateAutoFetchUI();
        };
        
        window.manualFetchResults = async function() {
            fetchLog('üîÑ Manuell h√§mtning...', 'info');
            await fetchPLResults();
        };
        
        async function fetchPLResults() {
            if (!plApiKey) {
                fetchLog('‚ùå Ingen API-nyckel konfigurerad', 'error');
                return;
            }
            
            fetchLog('‚öΩ Kollar PL-resultat...', 'info');
            let foundResults = 0;
            let checked = 0;
            
            for (const match of matches) {
                // Skip if already has result
                if (match.actualOutcome) continue;
                
                // Skip if match hasn't started yet
                if (!isMatchStarted(match.date)) continue;
                
                // Wait at least 100 minutes after match start
                const matchTime = new Date(match.date);
                const now = new Date();
                const hoursSinceStart = (now - matchTime) / (1000 * 60 * 60);
                if (hoursSinceStart < 100/60) {
                    fetchLog(`  ‚è∞ ${match.homeTeam} vs ${match.awayTeam}: V√§ntar (${hoursSinceStart.toFixed(1)}h)`, 'warning');
                    continue;
                }
                
                checked++;
                
                try {
                    const matchDate = match.date.split('T')[0];
                    const apiUrl = `https://api.football-data.org/v4/competitions/PL/matches?dateFrom=${matchDate}&dateTo=${matchDate}`;
                    const corsProxy = 'https://corsproxy.io/?';
                    const url = corsProxy + encodeURIComponent(apiUrl);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: { 'X-Auth-Token': plApiKey }
                    });
                    
                    if (response.status === 429) {
                        fetchLog('  ‚ö†Ô∏è Rate limit ‚Äì v√§ntar 60s...', 'warning');
                        await new Promise(r => setTimeout(r, 60000));
                        continue;
                    }
                    
                    if (!response.ok) {
                        fetchLog(`  ‚ö†Ô∏è API status ${response.status}`, 'warning');
                        continue;
                    }
                    
                    const data = await response.json();
                    const games = data.matches || [];
                    
                    // Find matching game by team names
                    const game = games.find(g => {
                        const apiHome = (g.homeTeam?.shortName || g.homeTeam?.name || '').toLowerCase();
                        const apiAway = (g.awayTeam?.shortName || g.awayTeam?.name || '').toLowerCase();
                        const ourHome = match.homeTeam.toLowerCase();
                        const ourAway = match.awayTeam.toLowerCase();
                        return (apiHome.includes(ourHome) || ourHome.includes(apiHome)) &&
                               (apiAway.includes(ourAway) || ourAway.includes(apiAway));
                    });
                    
                    if (!game) {
                        fetchLog(`  ‚ùå ${match.homeTeam} vs ${match.awayTeam}: Hittar ej i API`, 'warning');
                        continue;
                    }
                    
                    if (game.status !== 'FINISHED') {
                        fetchLog(`  ‚è≥ ${match.homeTeam} vs ${match.awayTeam}: ${game.status}`, 'info');
                        continue;
                    }
                    
                    const homeGoals = game.score?.fullTime?.home;
                    const awayGoals = game.score?.fullTime?.away;
                    
                    if (homeGoals === null || homeGoals === undefined || awayGoals === null || awayGoals === undefined) continue;
                    
                    // Determine 1X2
                    let outcome;
                    if (homeGoals > awayGoals) outcome = '1';
                    else if (homeGoals < awayGoals) outcome = '2';
                    else outcome = 'X';
                    
                    // Save result + actual score for bonus check
                    const matchIndex = matches.findIndex(m => m.id === match.id);
                    matches[matchIndex].actualOutcome = outcome;
                    matches[matchIndex].actualScore = `${homeGoals}-${awayGoals}`;
                    matches[matchIndex].setBy = 'API';
                    matches[matchIndex].setAt = new Date().toISOString();
                    
                    await set(ref(database, 'matches'), matches);
                    foundResults++;
                    fetchLog(`  ‚úÖ ${match.homeTeam} ${homeGoals}-${awayGoals} ${match.awayTeam}`, 'success');
                    await logActivity('AUTO_RESULT', `API: ${match.homeTeam} ${homeGoals}-${awayGoals} ${match.awayTeam}`);
                    
                    // Rate limit: wait 6s between requests (free = 10/min)
                    await new Promise(r => setTimeout(r, 6000));
                    
                } catch (error) {
                    fetchLog(`  ‚ùå ${match.homeTeam} vs ${match.awayTeam}: ${error.message}`, 'error');
                }
            }
            
            if (checked === 0) {
                fetchLog('‚ÑπÔ∏è Inga matcher att kolla just nu', 'info');
            } else {
                fetchLog(`‚úÖ Klar! ${foundResults} nya resultat av ${checked} kollade`, 'success');
            }

            await set(ref(database, 'lastAutoFetch'), new Date().toISOString());
        }

        // RESULT MODAL (Anyone can use after match starts)
        window.openResultModal = function(matchId) {
            const match = matches.find(m => m.id === matchId);
            if (!match) return;

            currentModalMatchId = matchId;
            currentModalOutcome = match.actualOutcome;

            document.getElementById('modalMatchInfo').textContent = `${match.homeTeam} vs ${match.awayTeam}`;
            document.getElementById('modalHome').textContent = match.homeTeam;
            document.getElementById('modalAway').textContent = match.awayTeam;
            document.getElementById('modalScoreHome').textContent = match.homeTeam;
            document.getElementById('modalScoreAway').textContent = match.awayTeam;

            // Populate exact score if exists
            if (match.actualScore) {
                const parts = match.actualScore.split('-');
                document.getElementById('modalHomeScore').value = parts[0];
                document.getElementById('modalAwayScore').value = parts[1];
            } else {
                document.getElementById('modalHomeScore').value = '';
                document.getElementById('modalAwayScore').value = '';
            }

            document.querySelectorAll('.modal-outcome-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (match.actualOutcome === null && btn.dataset.outcome === 'null') {
                    btn.classList.add('selected');
                } else if (btn.dataset.outcome === currentModalOutcome) {
                    btn.classList.add('selected');
                }
            });

            document.getElementById('resultModal').classList.add('active');
        };

        function handleModalOutcome(e) {
            const btn = e.target.closest('.modal-outcome-btn');
            if (!btn) return;
            
            const outcome = btn.dataset.outcome;
            currentModalOutcome = outcome === 'null' ? null : outcome;
            
            document.querySelectorAll('.modal-outcome-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        function closeModal() {
            const modal = document.getElementById('resultModal');
            if (modal) modal.classList.remove('active');
            currentModalMatchId = null;
            currentModalOutcome = null;
        }

        async function saveModalResult() {
            if (currentModalMatchId === null || currentModalOutcome === undefined) {
                alert('V√§lj ett alternativ f√∂rst!');
                return;
            }

            try {
                const matchIndex = matches.findIndex(m => m.id === currentModalMatchId);
                const match = matches[matchIndex];
                
                // Handle postponed matches
                if (currentModalOutcome === 'POSTPONED') {
                    matches[matchIndex].actualOutcome = 'POSTPONED';
                    matches[matchIndex].actualScore = null;
                    matches[matchIndex].setBy = currentUser;
                    matches[matchIndex].setAt = new Date().toISOString();
                    
                    await set(ref(database, 'matches'), matches);
                    await logActivity('POSTPONED_MATCH', `Markerade match som inst√§lld: ${match.homeTeam} vs ${match.awayTeam}`);
                    
                    closeModal();
                    alert('‚ö†Ô∏è Match markerad som inst√§lld. Alla spelare f√•r 0 po√§ng f√∂r denna match.');
                    return;
                }
                
                matches[matchIndex].actualOutcome = currentModalOutcome;
                matches[matchIndex].setBy = currentModalOutcome !== null ? currentUser : null;
                matches[matchIndex].setAt = currentModalOutcome !== null ? new Date().toISOString() : null;
                
                // Save exact score if provided (not for postponed matches)
                const homeScore = document.getElementById('modalHomeScore').value;
                const awayScore = document.getElementById('modalAwayScore').value;
                if (homeScore !== '' && awayScore !== '' && currentModalOutcome !== null && currentModalOutcome !== 'POSTPONED') {
                    matches[matchIndex].actualScore = `${homeScore}-${awayScore}`;
                } else {
                    matches[matchIndex].actualScore = null;
                }
                
                await set(ref(database, 'matches'), matches);
                
                // Log activity (no alert popups)
                if (currentModalOutcome === null) {
                    await logActivity('CLEAR_RESULT', `Rensade resultat f√∂r ${match.homeTeam} vs ${match.awayTeam}`);
                } else {
                    const outcomeText = { '1': match.homeTeam, 'X': 'Oavgjort', '2': match.awayTeam };
                    const scoreText = match.actualScore ? ` (${match.actualScore})` : '';
                    await logActivity('SET_RESULT', `Satte resultat ${outcomeText[currentModalOutcome]}${scoreText} p√• ${match.homeTeam} vs ${match.awayTeam}`);
                }
                
                closeModal();
            } catch (error) {
                console.error('Save error:', error);
                alert('‚ùå Fel: ' + error.message);
            }
        }

        // RENDER MATCHES
        function renderMatches() {
            const list = document.getElementById('matchesList');
            if (!list) return;
            
            if (!matches || matches.length === 0) {
                if (currentUser === 'Hefner') {
                    list.innerHTML = '<div class="empty-state">G√• till Admin-panelen, v√§lj antal omg√•ngar och klicka "H√§mta valda PL-omg√•ngar" f√∂r att starta t√§vlingen</div>';
                } else {
                    list.innerHTML = '<div class="empty-state">V√§ntar p√• att Hefner laddar in matcherna...</div>';
                }
                return;
            }

            list.innerHTML = matches.map(m => {
                const dateStr = new Date(m.date).toLocaleString('sv-SE', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                
                const started = isMatchStarted(m.date);
                const scoreStr = m.actualScore ? ` (${m.actualScore})` : '';
                const outcomeText = {
                    '1': `‚úÖ ${m.homeTeam} vann${scoreStr}`,
                    'X': `‚úÖ Oavgjort${scoreStr}`,
                    '2': `‚úÖ ${m.awayTeam} vann${scoreStr}`,
                    'POSTPONED': '‚ö†Ô∏è Match inst√§lld - Alla f√•r 0 po√§ng'
                };
                const setByText = m.setBy ? ` (inlagt av ${m.setBy})` : '';
                const status = m.actualOutcome ? outcomeText[m.actualOutcome] + setByText : 
                              (started ? '‚è≥ V√§ntar p√• resultat...' : 'üìÖ Ej startad');

                // Check who has predicted for this match
                const matchPredictions = predictions[m.id] || {};
                const matchExactPreds = exactPredictions[m.id] || {};
                const allPlayers = ['Hefner', 'Majscht', 'Olle', 'Dawod', 'Ante'];
                const predicted = allPlayers.filter(p => matchPredictions[p]);
                const notPredicted = allPlayers.filter(p => !matchPredictions[p]);
                
                // Show predictions BEFORE result is set
                let predictionStatusBefore = '';
                if (!m.actualOutcome) {
                    let predsHtml = '<div style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-radius: 5px; font-size: 0.9em;">';
                    predsHtml += '<div style="font-weight: 600; margin-bottom: 8px; color: #1e40af;">üìä Tippningar:</div>';
                    allPlayers.forEach(function(player) {
                        const pred = matchPredictions[player];
                        const exact = matchExactPreds[player];
                        if (!pred) {
                            predsHtml += '<div style="color: #6b7280; padding: 3px 0;">‚ùå ' + player + ': Tippade inte</div>';
                        } else {
                            const label = { '1': m.homeTeam, 'X': 'Oavgjort', '2': m.awayTeam }[pred] || pred;
                            const scoreDisplay = exact
                                ? '<strong>' + exact.replace('-', ' \u2013 ') + '</strong> <span style="color: #888; font-size: 0.85em;">(' + label + ')</span>'
                                : '<strong>' + label + '</strong>';
                            predsHtml += '<div style="color: #333; padding: 3px 0;">üéØ ' + player + ': ' + scoreDisplay + '</div>';
                        }
                    });
                    predsHtml += '</div>';
                    predictionStatusBefore = predsHtml;
                }

                // Show predictions AFTER result is set (what everyone tipped)
                const predictionStatusAfter = m.actualOutcome ? `
                    <div style="margin-top: 10px; padding: 10px; background: ${m.actualOutcome === 'POSTPONED' ? '#fef3c7' : '#f0f9ff'}; border-radius: 5px; font-size: 0.9em;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: ${m.actualOutcome === 'POSTPONED' ? '#f59e0b' : '#1e40af'};">üìä Alla tippningar${m.actualOutcome === 'POSTPONED' ? ' (Match inst√§lld - alla 0p)' : ''}:</div>
                        ${allPlayers.map(player => {
                            const playerPrediction = matchPredictions[player];
                            const playerExact = matchExactPreds[player];
                            const outcomeLabels = {
                                '1': m.homeTeam,
                                'X': 'Oavgjort',
                                '2': m.awayTeam
                            };
                            
                            if (!playerPrediction) {
                                return `<div style="color: #6b7280; padding: 3px 0;">‚ùå ${player}: Tippade inte</div>`;
                            }
                            
                            // For postponed matches, show neutral color (everyone gets 0 points)
                            if (m.actualOutcome === 'POSTPONED') {
                                const exactTag = playerExact ? ` [${playerExact}]` : '';
                                return `<div style="color: #f59e0b; padding: 3px 0;">‚ö†Ô∏è ${player}: ${outcomeLabels[playerPrediction]}${exactTag}</div>`;
                            }
                            
                            const isCorrect = playerPrediction === m.actualOutcome;
                            const exactCorrect = playerExact && m.actualScore && playerExact === m.actualScore;
                            const icon = isCorrect ? '‚úÖ' : '‚ùå';
                            const color = isCorrect ? '#10b981' : '#ef4444';
                            const exactTag = playerExact ? ` [${playerExact}]${exactCorrect ? ' ‚≠ê+25' : ''}` : '';
                            const pts = calculatePoints(m.id, player);
                            const ptsTag = ` <span style="background: ${isCorrect ? '#10b981' : '#e5e7eb'}; color: ${isCorrect ? 'white' : '#6b7280'}; padding: 1px 6px; border-radius: 10px; font-size: 0.82em; font-weight: 600;">${pts}p</span>`;

                            return `<div style="color: ${color}; padding: 3px 0; font-weight: ${isCorrect ? '600' : 'normal'};">${icon} ${player}: ${outcomeLabels[playerPrediction]}${exactTag}${ptsTag}</div>`;
                        }).join('')}
                    </div>
                ` : '';

                // Anyone can set results after match has started
                const canSetResult = started;
                const resultControls = canSetResult ? `
                    <div class="match-actions">
                        <button class="btn btn-secondary" onclick="openResultModal('${m.id}')">
                            ${m.actualOutcome ? '‚úèÔ∏è √Ñndra' : 'üìù S√§tt'} resultat
                        </button>
                    </div>
                ` : '';

                return `
                    <div class="match-item">
                        <div class="match-teams">${m.homeTeam} vs ${m.awayTeam}</div>
                        <div class="match-details">${m.league} ‚Ä¢ ${dateStr} ‚Ä¢ ${status}</div>
                        ${started && !m.actualOutcome ? '<div class="match-locked">üîí Matchen startad - Vem som helst kan s√§tta resultat</div>' : ''}
                        ${predictionStatusBefore}
                        ${predictionStatusAfter}
                        ${resultControls}
                    </div>
                `;
            }).join('');
        }

        // RENDER PREDICTIONS
        function renderPredictions() {
            const list = document.getElementById('predictionsList');
            if (!list) return;
            
            if (!currentUser) {
                list.innerHTML = '<div class="empty-state">Logga in f√∂r att tippa</div>';
                return;
            }

            if (!matches || matches.length === 0) {
                list.innerHTML = '<div class="empty-state">Inga matcher. G√• till Matcher-fliken och klicka "Ladda matcher"</div>';
                return;
            }

            const tippingClosed = isFirstMatchStarted();
            const firstMatch = getFirstMatch();

            let deadlineBanner = '';
            if (!tippingClosed && firstMatch) {
                const deadlineStr = new Date(firstMatch.date).toLocaleString('sv-SE', {
                    weekday: 'long', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                deadlineBanner = `<div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 10px; padding: 14px 18px; margin-bottom: 18px; color: #92400e; font-weight: 600; text-align: center;">
                    ‚è∞ Tippa klart innan <span style="color: #b45309;">${deadlineStr}</span> ‚Äì d√• st√§nger tippningen f√∂r ALLA matcher!
                </div>`;
            } else if (tippingClosed) {
                deadlineBanner = `<div style="background: #fee2e2; border: 2px solid #ef4444; border-radius: 10px; padding: 14px 18px; margin-bottom: 18px; color: #991b1b; font-weight: 700; text-align: center; font-size: 1.1em;">
                    üîí Tippning st√§ngd ‚Äì inga √§ndringar till√•tna
                </div>`;
            }

            list.innerHTML = deadlineBanner + matches.map(m => {
                const myPred = predictions[m.id]?.[currentUser];
                const myExact = exactPredictions[m.id]?.[currentUser];
                const matchActuallyStarted = isMatchStarted(m.date);
                const dateStr = new Date(m.date).toLocaleString('sv-SE', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                let predictionsHtml = '';
                if (matchActuallyStarted) {
                    const matchPreds = predictions[m.id] || {};
                    const matchExactPreds = exactPredictions[m.id] || {};
                    if (Object.keys(matchPreds).length > 0) {
                        predictionsHtml = `
                            <div class="predictions-revealed">
                                <h4>Alla tippningar:</h4>
                                ${Object.entries(matchPreds).map(([player, pred]) => {
                                    const playerExact = matchExactPreds[player];
                                    return `
                                    <div class="prediction-row">
                                        <span><strong>${player}</strong></span>
                                        <span style="font-weight: 600; color: #667eea;">
                                            ${playerExact ? playerExact.replace('-', ' ‚Äì ') : pred}
                                            <span style="color: #aaa; font-weight: 400; font-size: 0.85em;">(${pred})</span>
                                        </span>
                                    </div>
                                `}).join('')}
                            </div>
                        `;
                    }
                }

                return `
                    <div class="prediction-match ${tippingClosed ? 'locked' : ''}">
                        <div style="text-align: center; color: #666; font-size: 0.8em; margin-bottom: 10px;">
                            ${m.league} ‚Ä¢ ${dateStr}
                        </div>
                        ${tippingClosed ? `
                            <div style="text-align: center; font-size: 1.1em; font-weight: 700; color: #333; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #e0e0e0;">
                                ${m.homeTeam} <span style="color: #667eea;">vs</span> ${m.awayTeam}
                            </div>
                            <div class="locked-overlay">
                                üîí Tippning st√§ngd
                                ${myExact ? `<div style="margin-top: 6px; font-size: 0.9em; color: #667eea;">Din tipp: ${myExact.replace('-', ' ‚Äì ')}</div>` : '<div style="margin-top: 6px; font-size: 0.9em; color: #999;">Du tippade inte denna match</div>'}
                            </div>
                            ${predictionsHtml}
                        ` : `
                            <div class="score-entry">
                                <div class="score-entry-teams">
                                    <span class="score-team score-team-home">${m.homeTeam}</span>
                                    <div class="score-inputs">
                                        <input type="number" min="0" max="99" id="exact-home-${m.id}"
                                            value="${myExact ? myExact.split('-')[0] : ''}"
                                            oninput="updateScorePrediction('${m.id}')"
                                            class="score-input"
                                            placeholder="?">
                                        <span class="score-dash">‚Äì</span>
                                        <input type="number" min="0" max="99" id="exact-away-${m.id}"
                                            value="${myExact ? myExact.split('-')[1] : ''}"
                                            oninput="updateScorePrediction('${m.id}')"
                                            class="score-input"
                                            placeholder="?">
                                    </div>
                                    <span class="score-team score-team-away">${m.awayTeam}</span>
                                </div>
                                <div id="prediction-label-${m.id}" class="score-label">
                                    ${myExact ? `<span style="color: #667eea; font-weight: 600; font-size: 0.85em;">
                                        ${(() => { const [h,a] = myExact.split('-').map(Number); return h > a ? '1 ‚Äì ' + m.homeTeam + ' vinner' : h < a ? '2 ‚Äì ' + m.awayTeam + ' vinner' : 'X ‚Äì Oavgjort'; })()}
                                    </span>` : '<span style="color: #bbb; font-size: 0.85em;">Ange resultatet du tror p√•</span>'}
                                </div>
                                <div style="text-align: center;">
                                    <button class="btn" style="padding: 8px 24px; font-size: 0.9em;" onclick="saveScorePrediction('${m.id}')">Spara tips</button>
                                </div>
                            </div>
                            ${myExact ? '<div style="text-align: center; color: #667eea; font-weight: 600; margin-top: 6px; font-size: 0.85em;">‚úì Sparat: ' + myExact.replace('-', ' ‚Äì ') + '</div>' : ''}
                        `}
                    </div>
                `;
            }).join('');
        }

        // Live-uppdatering av 1X2-label n√§r man skriver in siffror
        window.updateScorePrediction = function(matchId) {
            const homeVal = document.getElementById(`exact-home-${matchId}`)?.value;
            const awayVal = document.getElementById(`exact-away-${matchId}`)?.value;
            const label = document.getElementById(`prediction-label-${matchId}`);
            const match = matches.find(m => m.id === matchId);
            if (!label || !match) return;

            if (homeVal === '' || awayVal === '') {
                label.innerHTML = '<span style="color: #aaa;">Ange resultatet du tror p√•</span>';
                return;
            }
            const h = parseInt(homeVal), a = parseInt(awayVal);
            let text, color;
            if (h > a)      { text = `1 ‚Äì ${match.homeTeam} vinner`; color = '#10b981'; }
            else if (h < a) { text = `2 ‚Äì ${match.awayTeam} vinner`; color = '#ef4444'; }
            else            { text = 'X ‚Äì Oavgjort'; color = '#f59e0b'; }
            label.innerHTML = `<span style="color:${color}; font-weight:600;">${text}</span>`;
        };

        // Spara resultat + automatisk 1X2
        window.saveScorePrediction = async function(matchId) {
            if (!currentUser) { alert('Du m√•ste vara inloggad!'); return; }

            const match = matches.find(m => m.id === matchId);
            if (isFirstMatchStarted()) {
                alert('Tippningen √§r st√§ngd! F√∂rsta matchen har redan startat ‚Äì inga √§ndringar till√•tna.');
                return;
            }

            const homeVal = document.getElementById(`exact-home-${matchId}`)?.value;
            const awayVal = document.getElementById(`exact-away-${matchId}`)?.value;

            if (homeVal === '' || awayVal === '') {
                alert('Fyll i b√•da siffrorna!');
                return;
            }

            const h = parseInt(homeVal), a = parseInt(awayVal);
            const outcome = h > a ? '1' : h < a ? '2' : 'X';
            const scoreStr = `${h}-${a}`;

            try {
                if (!predictions[matchId]) predictions[matchId] = {};
                predictions[matchId][currentUser] = outcome;
                if (!exactPredictions[matchId]) exactPredictions[matchId] = {};
                exactPredictions[matchId][currentUser] = scoreStr;

                await set(ref(database, 'predictions'), predictions);
                await set(ref(database, 'exactPredictions'), exactPredictions);

                await logActivity('PREDICT', `Tippade p√• ${match.homeTeam} vs ${match.awayTeam}`);

                renderPredictions();
                renderMatches();
            } catch (error) {
                console.error('Save error:', error);
                alert('‚ùå Fel: ' + error.message);
            }
        };
        function calculatePoints(matchId, player) {
            const match = matches.find(m => m.id === matchId);
            if (!match || !match.actualOutcome) return 0;
            
            // If match is postponed, everyone gets 0 points
            if (match.actualOutcome === 'POSTPONED') return 0;

            let points = 0;

            // 1X2 points
            const playerPred = predictions[matchId]?.[player];
            if (playerPred && playerPred === match.actualOutcome) {
                const samePredCount = Object.values(predictions[matchId] || {})
                    .filter(p => p === playerPred).length;

                if (samePredCount === 1) points = 100;
                else if (samePredCount === 2) points = 78;
                else if (samePredCount === 3) points = 55;
                else if (samePredCount === 4) points = 33;
            }

            // Exact score bonus (+25) - only if 1X2 was also correct
            if (points > 0 && match.actualScore && exactPredictions[matchId]?.[player]) {
                if (exactPredictions[matchId][player] === match.actualScore) {
                    points += 25;
                }
            }

            return points;
        }

        // RENDER LEADERBOARD
        function renderLeaderboard() {
            const tbody = document.getElementById('leaderboardBody');
            if (!tbody) return;
            
            const scores = PLAYERS.map(player => {
                let totalPoints = 0;
                let correctPreds = 0;
                let bonusCount = 0;
                let finishedMatches = 0;

                matches.forEach(match => {
                    if (match.actualOutcome && match.actualOutcome !== 'POSTPONED') {
                        finishedMatches++;
                        const points = calculatePoints(match.id, player);
                        totalPoints += points;
                        if (points > 0) correctPreds++;
                        if (match.actualScore && exactPredictions[match.id]?.[player] === match.actualScore && points > 0) {
                            bonusCount++;
                        }
                    }
                });

                return {
                    player,
                    totalPoints,
                    correctPreds,
                    bonusCount,
                    average: finishedMatches > 0 ? (totalPoints / finishedMatches).toFixed(1) : '0.0'
                };
            });

            // Sort: first by points, then by exact score count as tiebreaker
            scores.sort((a, b) => {
                if (b.totalPoints !== a.totalPoints) return b.totalPoints - a.totalPoints;
                return b.bonusCount - a.bonusCount;
            });

            tbody.innerHTML = scores.map((s, i) => {
                const rankClass = i < 5 ? `rank-${i + 1}` : '';
                const bonusDisplay = s.bonusCount > 0
                    ? `<span style="color: #667eea; font-weight: 600;">${s.bonusCount}</span>`
                    : '<span style="color: #ccc;">0</span>';
                return `
                    <tr>
                        <td><span class="rank ${rankClass}">${i + 1}</span></td>
                        <td><strong>${s.player}</strong></td>
                        <td><strong>${s.totalPoints}</strong></td>
                        <td>${s.correctPreds}</td>
                        <td>${bonusDisplay}</td>
                        <td>${s.average}</td>
                    </tr>
                `;
            }).join('');

            // Show special titles for positions 1, 4 and 5
            const specialTitlesDiv = document.getElementById('specialTitles');
            const masterSection = document.getElementById('masterSection');
            const sousChefSection = document.getElementById('sousChefSection');
            const chefSection = document.getElementById('chefSection');
            const masterName = document.getElementById('masterName');
            const sousChefName = document.getElementById('sousChefName');
            const chefName = document.getElementById('chefName');

            // Show M√§stare (1st place)
            if (scores.length >= 1) {
                masterName.textContent = scores[0].player;
                masterSection.style.display = 'block';
            } else {
                masterSection.style.display = 'none';
            }

            // Show Sous-chef (4th place)
            if (scores.length >= 4) {
                sousChefName.textContent = scores[3].player;
                sousChefSection.style.display = 'block';
            } else {
                sousChefSection.style.display = 'none';
            }

            // Show Chef (5th place)
            if (scores.length >= 5) {
                chefName.textContent = scores[4].player;
                chefSection.style.display = 'block';
            } else {
                chefSection.style.display = 'none';
            }

            // Show Ligans Sniper (most solo correct predictions = 100p matches)
            const sniperSection = document.getElementById('sniperSection');
            const sniperName = document.getElementById('sniperName');
            const sniperDetails = document.getElementById('sniperDetails');
            
            const sniperCounts = PLAYERS.map(player => {
                let soloCorrect = 0;
                matches.forEach(match => {
                    if (match.actualOutcome && calculatePoints(match.id, player) === 100) {
                        soloCorrect++;
                    }
                });
                return { player, soloCorrect };
            }).sort((a, b) => b.soloCorrect - a.soloCorrect);
            
            if (sniperCounts[0] && sniperCounts[0].soloCorrect > 0) {
                sniperName.textContent = sniperCounts[0].player;
                sniperDetails.textContent = `${sniperCounts[0].soloCorrect} st 100-po√§ngare`;
                sniperSection.style.display = 'block';
            } else {
                sniperSection.style.display = 'none';
            }

            // Show the titles section if we have at least position 1
            if (scores.length >= 1) {
                specialTitlesDiv.style.display = 'block';
            } else {
                specialTitlesDiv.style.display = 'none';
            }
        }

        // SHOW TAB
        function handleTab(e) {
            const tabName = e.target.dataset.tab;
            if (!tabName) return;

            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            e.target.classList.add('active');

            if (tabName === 'leaderboard') renderLeaderboard();
            if (tabName === 'predict') renderPredictions();
            if (tabName === 'admin' && currentUser === 'Hefner') renderActivityLog();
        }

        // EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, setting up event listeners...');
            
            // Login
            const loginBtn = document.getElementById('loginButton');
            if (loginBtn) {
                loginBtn.addEventListener('click', handleLogin);
                console.log('Login button listener added');
            }

            // Logout
            const logoutBtn = document.getElementById('logoutButton');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
                console.log('Logout button listener added');
            }

            // Password enter key
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });
                console.log('Password enter key listener added');
            }

            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', handleTab);
            });
            console.log('Tab listeners added');

            // Admin modal (for Hefner)
            const modalOutcomeButtons = document.getElementById('modalOutcomeButtons');
            if (modalOutcomeButtons) {
                modalOutcomeButtons.addEventListener('click', handleModalOutcome);
            }

            const modalCancelBtn = document.getElementById('modalCancelBtn');
            if (modalCancelBtn) {
                modalCancelBtn.addEventListener('click', closeModal);
            }

            const modalSaveBtn = document.getElementById('modalSaveBtn');
            if (modalSaveBtn) {
                modalSaveBtn.addEventListener('click', saveModalResult);
            }

            const modal = document.getElementById('resultModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target.id === 'resultModal') closeModal();
                });
            }

            console.log('All event listeners set up successfully');
        });
    </script>
</body>
</html>
